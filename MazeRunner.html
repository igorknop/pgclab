<!DOCTYPE html>
<html lang="pt" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Maze Runner - Aplicação de técnicas na geração procedural de conteúdo</title>
  <script src="Classes/Map.js"></script>
  <script src="Classes/Room.js"></script>
  <script src="Classes/Level.js"></script>
  <script src="Classes/Sprite.js"></script>
  <script src="Classes/Player.js"></script>
  <script src="Classes/Teleporter.js"></script>
  <!--
    <script src="Classes/ImageLibrary.js"></script>
    <script src="Classes/AudioLibrary.js"></script>
  -->
  <script src="Classes/AssetsManager.js"></script>
  <script src="Classes/CellularAutomata.js"></script>
  <script src="Classes/FireZone.js"></script>
  <script src="Classes/SeedGenerator.js"></script>

  <link rel="stylesheet" href="CSS/default.css">
 <!-- <style>
    body {
      padding: 20px;
      margin: 0;
    }

    canvas {
      vertical-align: top;
    }
  </style>

  <style>
    body {
      background-color: lightblue;
      color: black;
    }
  </style>
-->
</head>

<body>
  <!-- <h1 align="center"><u>Trabalho de conclusão de curso de ciências exatas:</u> (2019)</h1> 
  <h2>&emsp;&emsp;Tema: Aplicação de autômatos celulares na geração procedural de mapas.</h2>
  -->

  <canvas id="canvas" width="600px" height="350px"> 
    Seu browser não suporta canvas!
  </canvas>

  <script>
    var tela = document.getElementById("canvas");
    
    //Ocupa a janela toda
    tela.width  = window.innerWidth;
    tela.height = window.innerHeight;
    tela.widthOld = 600;
    tela.heightOld = 350;

    tela.style.border = '2px solid #000';                       //Colocando borda no canvas
    var ctx = tela.getContext("2d");
    var fullscreen = false;
    var anterior = dt = 0;
    var estado = 1;

    // Controle das imagens e sons presentes no jogo
    var assetsMng = new AssetsManager();

    // Carregamento das imagens do jogo
    assetsMng.loadImage("brick_gray", "Assets/Imagens/brick_gray.png");
    assetsMng.loadImage("brick_dark_Tp_0", "Assets/Imagens/brick_dark0.png");
    assetsMng.loadImage("floor_sand", "Assets/Imagens/floor_sand_stone0.png");
    assetsMng.loadImage("rockBlock", "Assets/Imagens/rock.png");
    assetsMng.loadImage("grass_full", "Assets/Imagens/grass_full.png");
    assetsMng.loadImage("player", "Assets/Imagens/player-sprite.png");    
    assetsMng.loadImage("flames", "Assets/Imagens/flames.png");    

    // Carregamento dos audios presentes no jogo
    assetsMng.loadAudio("teleporte", "Assets/Audios/Teleport.wav");

    // SeedGenerator ===> Utilizado para retornar ao mesmo mapa com apenas o código da seed
    var seedValueURL = location.search;

    if(seedValueURL.length != 0){                   //SEED PASSADA NA URL
      let aux = "?seed=";
      seedValueURL = seedValueURL.substring(aux.length, seedValueURL.length);
      seedValueURL = parseInt(seedValueURL);
    }
    else{                                           //sEED ALEATÓRIA
      let maxValue = 5000000;
      let minValue = 500000;
      seedValueURL = (Math.floor(Math.random() * (maxValue - minValue)) + minValue);
    }
    var seedGen = new SeedGenerator({seed_1: seedValueURL , seed_2_string: "teste"});

    // Proporções do mapa
    
    var widthMap = 120;   
    var heightMap = 120;  
    var sizeMap = 32;     
    var MAPA_AREA = 20;  
    var escala = 1.8;
    var K = 1;
    var debugMode = 0;  //  0 => Colision is detected, 1 => colision is free

    var player = new Player(16, "player");

    var levelAtual = new Level(widthMap, heightMap, sizeMap);
    var levels = [];
    levels.push(new Level(widthMap, heightMap, sizeMap));

    /**
      METODO DE SUBMATRIZES
    */
    
    /*
    var geraFase = new CellularAutomata(Math.floor(heightMap / K), Math.floor(widthMap / K), 1, 0.5, 4, 0, 5, 1);//new CellularAutomata(heightMap, widthMap, 2, 0.5, 13, 0, 5, 1);
    // 0 => floor
    // 5 => rock
    // 1 => wall
    for(var k = 0; k<K; k++){
      geraFase.scenarioRandomWall();
      geraFase.fullstep(2);
      //geraFase.fullstep(6);
      levels[0].setMatrixMap2(getelaraFase.map, Math.floor(k/3)*40, (k%3)*40);
    }
    geraFase.countRooms();
    geraFase.filterRooms(15);
    for(var k = 0; k<K; k++){
      levels[0].setMatrixMap2(geraFase.map, Math.floor(k/3)*40, (k%3)*40);
    }
    */

    /**
      METODO DA MATRIZ TOTAL
    */
    var geraFase = new CellularAutomata(heightMap, widthMap, 1, 0.5, 4, 0, 5, 1);//new CellularAutomata(heightMap, widthMap, 2, 0.5, 13, 0, 5, 1);
    // 0 => floor
    // 5 => rock
    // 1 => wall
    geraFase.scenarioRandomWall();
    geraFase.fullstep(2);
    geraFase.countRooms();
    geraFase.filterRooms(25);
    levels[0].setMatrixMap(geraFase.map);       // Copia a matriz de tipos dentro do gerador
    levels[0].copiaSalas(geraFase.rooms);       // Copia os dados em que os blocos da sala são apenas as posições linha e coluna da matriz
    levels[0].setTeleporters();                 // Posiciona os teleportes das salas e referencia a celula no mapa ao invés de colocar só a posição
    levels[0].atualizaGradeTeleportes(dt);
    levels[0].posicionarPlayer(player);
    levels[0].atualizaMatrizDistancias();       // Em relação aos teleportes inicial da fase e de cada sala
    levels[0].posicionarFireZones(25);

    levels[0].setTempo(10, 125);                // 10 segundos
    levels[0].tesouros = 3;

    var tempoGameOver = 2;
    var tempoTransicaoFase = 1;                 // Tempo que decai um pouco da barra
    var playerVel = 300;

    levelAtual.clonarLevel(levels[0]);
    player.map = levelAtual.mapa;

    var teasuresCollected = 0;    

    //Tempo
    var tempoRectExt = new Sprite();
    var tempoRectInt = new Sprite();
    tempoRectExt.w = 127; //102
    tempoRectExt.h = 15;
    tempoRectExt.colorBG = "black";
    tempoRectExt.colorBorder = "white";
    tempoRectExt.x = 95;
    tempoRectExt.y = 7;
    tempoRectInt.w = 127; //100
    tempoRectInt.h = 15;
    tempoRectInt.x = 96;
    tempoRectInt.y = 8;
    tempoRectInt.colorBG = "rgb(170,120,0)";
    tempoRectInt.borderSize = 0;

    //Main Menu campos
    var fontMainMenu = "30px Arial Black";
    var wordsColor = "white";
    var alignMainMenu = "center";
    var stateMainMenu = 0;

    /************************************
    *   --------- DEBUG MODE -----------*
    *                                   *
    *       0 => Normal;                *
    *       1 => Centro Player;         *
    *       2 => Box Collision;         *
    *       3 => Dados das celulas:     *
    *             (Firezones)           *
    *           - tipo(amarelo);        *
    *           - room(verde);          *
    *           - distFirezones         *
    *               (azul));            *
    *       4 => Dados das celulas:     *
    *             (Inimigos)            *
    *           - tipo(amarelo);        *
    *           - room(verde);          *
    *           - distInimigos          *
    *               (azul));            *
    *                                   *
    *************************************/

    /************************************
    *   --------- ESTADOS -----------   *
    *                                   *
    *       0 => Jogando;               *
    *       1 => Menu principal;        *
    *       2 => Game over;             *
    *       3 => Jogo fechado;          *
    *       4 => Passou de fase;        *
    *       5 => Reiniciar fase;        *
    *                                   *
    *************************************/

    requestAnimationFrame(passo);
    function passo(t) {
      dt = (t - anterior) / 1000;
      if(assetsMng.progresso() === 100){       // Verifica se carregou todos os arquivos do jogo
        switch (estado) {
          case 0:     // Jogando
            limparTela();
            /*if(audioLibrary.isPlaying("BGM")==false){
              audioLibrary.play("BGM");
            }*/
            player.moverCompleto(dt);
            levelAtual.colisaoFireZones(player);
            if(levelAtual.tempoFase >= 0){
              controleTempo();
            }
            else{
              if(debugMode != 0){
                player.moverCompleto(dt);
              }
              else{
                estado = 5;
                limparTela();
              }
            }
            ctx.save();
            ctx.scale(escala, escala);
            ctx.translate(-player.x + tela.width/4 , - player.y + tela.height/4);            
            levelAtual.desenhar(ctx);
            player.desenhar(ctx);
            ctx.restore();
            desenharHUD(ctx);
            break;
          case 1:         // Main menu
            limparTela();
            //imageLibrary.drawSize(ctx, "BG", 0, 0, tela.width, tela.height); // Imagem do fundo
            //if(audioLibrary.isPlaying("BGM")==false){
            //audioLibrary.play("BGM");
            //}
            ctx.fillStyle = wordsColor;
            ctx.textAlign = alignMainMenu;
            ctx.lineWidth = 2;
            ctx.strokeStyle = "black";
            ctx.font = "40px Arial Black";
            ctx.strokeText("Maze Runner", tela.width/2, tela.height/3 - 50);
            ctx.fillText("Maze Runner", tela.width/2, tela.height/3 - 50);
            ctx.font = "15px Arial Black";
            ctx.font = fontMainMenu;
            if (stateMainMenu == 0) {
              ctx.fillStyle = "yellow";
              ctx.strokeText("New Game", tela.width / 2, tela.height / 2 - 60);
              ctx.fillText("New Game", tela.width / 2, tela.height / 2 - 60);
              ctx.fillStyle = wordsColor;
              ctx.strokeText("Quit", tela.width / 2, tela.height / 2 - 10);
              ctx.fillText("Quit", tela.width / 2, tela.height / 2 - 10);
            }
            else {
              ctx.fillStyle = wordsColor;
              ctx.strokeText("New Game", tela.width / 2, tela.height / 2 - 60);
              ctx.fillText("New Game", tela.width / 2, tela.height / 2 - 60);
              ctx.fillStyle = "yellow";
              ctx.strokeText("Quit", tela.width / 2, tela.height / 2 - 10);
              ctx.fillText("Quit", tela.width / 2, tela.height / 2 - 10);
            }

            break;
          case 2:     // Game Over
            limparTela();
            //audioLibrary.stop("BGM");
            ctx.fillStyle = "white";
            ctx.textAlign = alignMainMenu;
            ctx.font = "40px Arial Black";
            ctx.lineWidth = 2;
            ctx.strokeStyle = "black";
            ctx.strokeText("GAME OVER", tela.width / 2, tela.height / 2);
            ctx.fillText("GAME OVER", tela.width / 2, tela.height / 2);

            if (tempoGameOver >= 0) {
              tempoGameOver = tempoGameOver - 0.7 * dt;
            }
            else {
              limparDados();
              estado = 1;
            }

            break;
          case 3:       // Tela preta == Jogo finalizado
            limparTela();
            break;
          case 4:       // Passou de fase
            tempoRectInt.w = 127;
            treasuresCount = 0;
            minesCount = 0;
            tempoTransicaoFase = 1;
            teasuresCollected = 0;
            player.levelNumber = player.levelNumber + 1;
            loadLevel(0);       //Load new level
            break;
          case 5:     // Recarregar fase
            tempoRectInt.w = 127;
            treasuresCount = 0;
            minesCount = 0;
            tempoTransicaoFase = 1;
            teasuresCollected = 0;
            player.vidas--;
            if(player.vidas < 0){       // Game over
              estado = 2;
              tempoGameOver = 2;
            }
            else{
              loadLevel(1);   // Reload Level
            }
            break;
          default:
        }
      }
      anterior = t;
      requestAnimationFrame(passo);
    }

    //  A cada 1 segundo ele executa uma diminuição na barra de tempo
    function controleTempo(){
      if(tempoTransicaoFase < 0){
        tempoTransicaoFase = 1;
        if(player.morre){
          tempoRectInt.w = tempoRectInt.w - levelAtual.taxaDiminuicaoTempo;  
          levelAtual.updateTempo(player);
        }
        else{
          tempoRectInt.w = 127;
        }
        if(tempoRectInt.w <= 0){
          tempoRectInt.w = 0;
        }
      }
      else{
        tempoTransicaoFase -= dt;        
        if(!player.morre){
          tempoRectInt.w = 127;
          levelAtual.tempoFase = levelAtual.tempoTotal;
        }
      }
    }

    function desenharHUD(){
      tempoRectExt.x = converteTelaCheia(77, tela.widthOld, tela.width);
      tempoRectExt.y = converteTelaCheia(13.5, tela.heightOld, tela.height);
      
      tempoRectInt.x = converteTelaCheia(77, tela.widthOld, tela.width);
      tempoRectInt.y = converteTelaCheia(13.5, tela.heightOld, tela.height);
      
      tempoRectExt.desenharTempo(ctx);
      tempoRectInt.desenharTempo(ctx);

      ctx.font = "15px Arial Black";
      ctx.fillStyle = "white";
      ctx.textAlign = alignMainMenu;
      ctx.lineWidth = 2;
      ctx.strokeStyle = "black";
      ctx.strokeText("Tempo: ", converteTelaCheia(55, tela.widthOld, tela.width), converteTelaCheia(20, tela.heightOld, tela.height));
      ctx.fillText("Tempo: ", converteTelaCheia(55, tela.widthOld, tela.width), converteTelaCheia(20, tela.heightOld, tela.height));
      ctx.strokeText("Vidas: " + player.vidas, converteTelaCheia(300, tela.widthOld, tela.width), converteTelaCheia(20, tela.heightOld, tela.height));
      ctx.fillText("Vidas: " + player.vidas, converteTelaCheia(300, tela.widthOld, tela.width), converteTelaCheia(20, tela.heightOld, tela.height));
      ctx.strokeText("Tesouros: " + teasuresCollected, converteTelaCheia(430, tela.widthOld, tela.width), converteTelaCheia(20, tela.heightOld, tela.height));
      ctx.fillText("Tesouros: " + teasuresCollected, converteTelaCheia(430, tela.widthOld, tela.width), converteTelaCheia(20, tela.heightOld, tela.height));
      ctx.strokeText("Level: " + player.levelNumber, converteTelaCheia(545, tela.widthOld, tela.width), converteTelaCheia(20, tela.heightOld, tela.height));
      ctx.fillText("Level: " + player.levelNumber, converteTelaCheia(545, tela.widthOld, tela.width), converteTelaCheia(20, tela.heightOld, tela.height));

      if(debugMode >= 1){
        ctx.font = "13px Arial Black";        
        let typeMode = "";
        switch(debugMode){
          case 1: // Centro do personagem e celula marcada
            typeMode = "Mode 1 - Centro personagem - Teleportes";
            break;
          case 2: // Box collision
            typeMode = "Mode 2 - Caixa de Colisão";
            break;
          case 3: // Dados das celulas -- DistFirezones
            typeMode = "Mode 3 - Dados das Celulas - DistFirezones";
            break;
          case 4: // Dados das celulas -- DistInimigos
            typeMode = "Mode 4 - Dados das Celulas - DistInimigos";
            break;
          default:
        }
        ctx.fillStyle = "black";
        ctx.strokeStyle = "yellow";
        ctx.fillRect(converteTelaCheia(5, tela.widthOld, tela.width), converteTelaCheia(310, tela.heightOld, tela.height), converteTelaCheia(555, tela.widthOld, tela.width), converteTelaCheia(37, tela.heightOld, tela.height));
        ctx.strokeRect(converteTelaCheia(5, tela.widthOld, tela.width), converteTelaCheia(310, tela.heightOld, tela.height), converteTelaCheia(555, tela.widthOld, tela.width), converteTelaCheia(37, tela.heightOld, tela.height));
        ctx.strokeStyle = "black";
        ctx.fillStyle = "yellow";
        ctx.strokeText("Debug mode ativado!!!", converteTelaCheia(110, tela.widthOld, tela.width), converteTelaCheia(320, tela.heightOld, tela.height));
        ctx.fillText("Debug mode ativado!!!", converteTelaCheia(110, tela.widthOld, tela.width), converteTelaCheia(320, tela.heightOld, tela.height));
        ctx.strokeText(typeMode, converteTelaCheia(110, tela.widthOld, tela.width), converteTelaCheia(330, tela.heightOld, tela.height));
        ctx.fillText(typeMode, converteTelaCheia(110, tela.widthOld, tela.width), converteTelaCheia(330, tela.heightOld, tela.height));
        ctx.strokeText("FPS: " + ((1/dt).toFixed(4)), converteTelaCheia(110, tela.widthOld, tela.width), converteTelaCheia(340, tela.heightOld, tela.height));
        ctx.fillText("FPS: "   + ((1/dt).toFixed(4)), converteTelaCheia(110, tela.widthOld, tela.width), converteTelaCheia(340, tela.heightOld, tela.height));
        ctx.strokeText("Escala mapa: " + escala.toFixed(4), converteTelaCheia(500, tela.widthOld, tela.width), converteTelaCheia(320, tela.heightOld, tela.height));
        ctx.fillText("Escala mapa: " + escala.toFixed(4), converteTelaCheia(500, tela.widthOld, tela.width), converteTelaCheia(320, tela.heightOld, tela.height));
        ctx.strokeText("Player: [" + (player.gy) + "][" + (player.gx) + "]", converteTelaCheia(500, tela.widthOld, tela.width), converteTelaCheia(340, tela.heightOld, tela.height));
        ctx.fillText("Player: [" + (player.gy) + "][" + (player.gx) + "]", converteTelaCheia(500, tela.widthOld, tela.width), converteTelaCheia(340, tela.heightOld, tela.height));

        ctx.strokeText("Teleporte Inicial Level: [" + (levelAtual.teleporteInicioLevel.gy) + "][" + (levelAtual.teleporteInicioLevel.gx) + "]", converteTelaCheia(tela.widthOld/2, tela.widthOld, tela.width), converteTelaCheia(320, tela.heightOld, tela.height));
        ctx.fillText("Teleporte Inicial Level: [" + (levelAtual.teleporteInicioLevel.gy) + "][" + (levelAtual.teleporteInicioLevel.gx) + "]", converteTelaCheia(tela.widthOld/2, tela.widthOld, tela.width), converteTelaCheia(320, tela.heightOld, tela.height));
        ctx.strokeText("Teleporte Inicial Level: [" + (levelAtual.teleporteFinalLevel.gy) + "][" + (levelAtual.teleporteFinalLevel.gx) + "]", converteTelaCheia(tela.widthOld/2, tela.widthOld, tela.width), converteTelaCheia(340, tela.heightOld, tela.height));
        ctx.fillText("Teleporte Inicial Level: [" + (levelAtual.teleporteFinalLevel.gy) + "][" + (levelAtual.teleporteFinalLevel.gx) + "]", converteTelaCheia(tela.widthOld/2, tela.widthOld, tela.width), converteTelaCheia(340, tela.heightOld, tela.height));
      }
    }

    // Conversão de escalas para o canvas ocupando a tela toda
    function converteTelaCheia(valorAntigo, telaAntiga, telaNova){
      let aux = Math.round(((valorAntigo * 100)/telaAntiga) * 100)/ 100;  // Arrendonda a porcentagem para duas casas decimais
      return parseInt((aux / 100) * telaNova);
    }

    // Atualiza o formato do convas ao mudar o formato da janela ou ser redimensionada
    function onResize(){
      tela.width = window.innerWidth;
      tela.height = window.innerHeight;
    }

    window.addEventListener('resize', onResize, false);         // Ouve os eventos de resize

    function limparDados() {
      levelAtual = new Level(widthMap, heightMap, sizeMap);
      levelAtual.clonarLevel(levels[0]);
      //levelAtual.updateGradeSalas();
      player = new Player(12, "player");
      player.map = levelAtual.mapa;
      player.x = levelAtual.startX;
      player.y = levelAtual.startY;
      /*player = new Player(12, "player");
      tempoGameOver = 2;
      stateMainMenu = 0;
      tempoRectInt.w = 127;
      teasuresCollected = 0;
      tempoTransicaoFase = 1;
      geraFase = new CellularAutomata(heightMap, widthMap, 1, 0.5, 4, 0, 5, 1); // new CellularAutomata(heightMap, widthMap, 2, 0.5, 13, 0, 5, 1);
      // 0 => floor
      // 5 => rock
      // 1 => wall
      geraFase.scenarioRandomWall();
      geraFase.fullstep(2);
      geraFase.countRooms();
      geraFase.filterRooms(25);
      levels = [];
      levels.push(new Level(widthMap, heightMap, sizeMap));
      levels[0].setMatrixMap(geraFase.map);
      levels[0].copiaSalas(geraFase.rooms);
      levels[0].updateGradeSalas();
      levels[0].setTeleporters();
      levels[0].posicionarPlayer(player);

      levels[0].tesouros = 3;
      levels[0].finishGX = 17;
      levels[0].finishGY = 9;*/
    }

    function limparTela() {
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, tela.width, tela.height);
    }

    function getRandomArbitrary(min, max) {
      return Math.floor(Math.random() * (max - min)) + min;                     //Seleciona um valor entre o min e o max
    }

    function loadLevel(option) {
      switch(option){
        case 0:   //Load New Level
          if (player.levelNumber > levels.length) {
            limparDados();
            estado = 1;
          }
          else {
            player.x = levels[player.levelNumber - 1].startX;
            player.y = levels[player.levelNumber - 1].startY;
            levelAtual.clonarLevel(levels[player.levelNumber - 1]);
            estado = 0;
          }
          break;
        case 1:   //Reload
          player.x = levels[player.levelNumber - 1].startX;
          player.y = levels[player.levelNumber - 1].startY;
          levelAtual.clonarLevel(levels[player.levelNumber - 1]);
          estado = 0;
          break;
      }
      
    }

    //FullScreen
    /* View in fullscreen */
    function openFullscreen() {
      if (tela.requestFullscreen) {
        tela.requestFullscreen();
      } else if (tela.mozRequestFullScreen) { /* Firefox */
        tela.mozRequestFullScreen();
      } else if (tela.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
        tela.webkitRequestFullscreen();
      } else if (tela.msRequestFullscreen) { /* IE/Edge */
        tela.msRequestFullscreen();
      }
    }

    /* Close fullscreen */
    function closeFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.mozCancelFullScreen) { /* Firefox */
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) { /* IE/Edge */
        document.msExitFullscreen();
      }
    }

    addEventListener("keydown", function (e) {
      //console.log(e.keyCode);
      if (estado == 0) {
        switch (e.keyCode) {
          case 70:    //Letra F
            fullscreen = !fullscreen;
            if(fullscreen){
              openFullscreen();
            }
            else{
              closeFullscreen();
            }
            break;
          case 37:
            //if(player.up === false && player.down === false && player.right === false){
            player.vx = -playerVel;
            //player.gx = player.gx - 1;
            player.left = true;
            player.sentidoMovimento = 2;
            //}
            break;
          case 39:
            //if(player.up === false && player.down === false && player.left === false){
            player.vx = +playerVel;
            //player.gx = player.gx + 1;
            player.right = true;
            player.sentidoMovimento = 0;
            //}

            break;
          case 32:  //Espaco  -- Ativa teleporte
            for(let i = 0; i < levelAtual.rooms.length; i++){
              if(levelAtual.rooms[i].teleporterInitial.colidiuCom2(player)){
                levelAtual.rooms[i].teleporterInitial.teleportar(player);
                break;
              }
              if(levelAtual.rooms[i].teleporterFinal.colidiuCom2(player)){
                levelAtual.rooms[i].teleporterFinal.teleportar(player);
                break;
              }
            }
            player.moverCompleto(dt);
            break;
          case 17:  //Left CTRL
            player.atacando = 1;  
            break;
          case 38:
            //if(player.left === false && player.down === false && player.right === false){
            player.vy = -playerVel;
            //player.gy = player.gy - 1;
            player.up = true;
            player.sentidoMovimento = 3;
            //}
            break;
          case 40:
            //if(player.left === false && player.up === false && player.right === false){
            player.vy = +playerVel;
            //player.gy = player.gy + 1;
            player.down = true;
            player.sentidoMovimento = 1;
            //}
            break;
          case 27:      //Pressionar o Esq
            stateMainMenu = 0;
            limparDados();
            estado = 1;
            break;
          case 80:      //Pressionar a letra P
            debugMode = debugMode + 1;
            if(debugMode > 4){
              debugMode = 0;
            }
            switch(debugMode){
              case 0: //Padrão do jogo
                debugMode = 0;
                escala = 1.8;
                MAPA_AREA = 20;
              break;
            }
            break;
          case 187:
          case 107:      //+
            if(debugMode >= 1){
              escala = escala + 0.025;
              if(escala >= 0.85)
                MAPA_AREA = 20;
              else{
                if(escala > 0.3){
                  MAPA_AREA = 80;
                }
                else{
                  if(escala >=  0.0){
                    MAPA_AREA = 160;
                  }
                }
              }
            }
            break;
          case 189:
          case 109:      //-
            if(debugMode >= 1){
              escala = escala - 0.025;
              if(escala >= 0.85)
                MAPA_AREA = 20;
              else{
                if(escala > 0.3){
                  MAPA_AREA = 80;
                }
                else{
                  if(escala >=  0.0){
                    MAPA_AREA = 160;
                  }
                }
              }
            }
            break;
          default:
        }

      }
      else {
        if (estado == 2) {
          switch (e.keyCode) {
            case 70:    //Letra F
              fullscreen = !fullscreen;
              if(fullscreen){
                openFullscreen();
              }
              else{
                closeFullscreen();
              }
            break;
            case 13:    //Enter
              limparDados();
              estado = 1;
              break;
            default:
          }
        }
        else {
          switch (e.keyCode) {
            case 70:    //Letra F
              fullscreen = !fullscreen;
              if(fullscreen){
                openFullscreen();
              }
              else{
                closeFullscreen();
              }
            break;
            case 13:    //Enter
            case 32:    //Space bar
              if (estado != 2) {
                if (stateMainMenu == 0) {
                  levelAtual = new Level(widthMap, heightMap, sizeMap);
                  levelAtual.clonarLevel(levels[0]);
                  //levelAtual.updateGradeSalas();
                  player = new Player(12, "player");
                  player.map = levelAtual.mapa;
                  player.x = levelAtual.startX;
                  player.y = levelAtual.startY;
                  estado = 0;
                }
                else {
                  estado = 3;
                }
              }
              break;
            case 38:
              if (stateMainMenu == 1) {
                stateMainMenu = 0;
              }
              break;
            case 40:
              if (stateMainMenu == 0) {
                stateMainMenu = 1;
              }
              break;
            case 27:      //Pressionar o Esq
              stateMainMenu = 0;
              limparDados();
              estado = 1;
              break;
            default:
          }
        }
      }

    });

    addEventListener("keyup", function (e) {
      if (player != null) {
        switch (e.keyCode) {
          case 37:
            player.vx = 0;
            player.left = false;
            break;
          case 39:
            player.vx = 0;
            player.right = false;
            break;
          case 38:
            player.vy = 0;
            player.up = false;
            break;
          case 40:
            player.vy = 0;
            player.down = false;
            break;
          case 17:  //Left CTRL
            player.atacando = 0;  
            break;
          default:
            break;
        }
      }
    });
  </script>
</body>

</html>